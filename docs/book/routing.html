
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Routing &#8212; Python web framework from scracth 0.0.1 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="From Raw WSGI to a framework" href="raw_wsgi.html" />
    <link rel="prev" title="Middlewares" href="middlewares.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="routing">
<h1>Routing<a class="headerlink" href="#routing" title="Permalink to this headline">¶</a></h1>
<p>Routing is the mechanism which allows our application to call different
parts according to the requested URL.
Until now only saw applications that always give the same response to any
requested URL.</p>
<div class="section" id="using-path-info">
<h2>Using <code class="docutils literal"><span class="pre">PATH_INFO</span></code><a class="headerlink" href="#using-path-info" title="Permalink to this headline">¶</a></h2>
<p>The requested URL contains a <code class="docutils literal"><span class="pre">PATH_INFO</span></code> which is passed to our WSGI
application via the <code class="docutils literal"><span class="pre">environment</span></code> dictionary.
We can write our application as a giant case switch to match a specific
<code class="docutils literal"><span class="pre">PATH_INFO</span></code> to a specific behavior:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">giant_wsgi_case_app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;200 OK&#39;</span>  <span class="c1"># HTTP Status</span>
    <span class="c1"># HTTP Headers</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain; charset=utf-8&#39;</span><span class="p">)]</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
    <span class="c1"># The returned object is going to be printed</span>
    <span class="k">if</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/hello&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;Hello World&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/bye&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;Good bye&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="o">...</span>
         <span class="o">...</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;Not found&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>This would be very un-pythonic and cumbersome to extend. Essentianly, this
problem is solved by all web framework with some kind of a routing
middleware. But before we examine how it is done by some of the most famous
WSGI frameworks, we implement a primitive routing middleware on our own.</p>
<div class="section" id="exercise-4">
<h3>Exercise 4<a class="headerlink" href="#exercise-4" title="Permalink to this headline">¶</a></h3>
<p>A small improvement would be to replace the giant <code class="docutils literal"><span class="pre">if</span> <span class="pre">...</span> <span class="pre">elif</span> <span class="pre">...</span> <span class="pre">else</span></code>
with a dictionary and map a <code class="docutils literal"><span class="pre">PATH_INFO</span></code> to a callable. The middleware should use this mapping to call the correct WSGI callable.</p>
<div class="toggle admonition">
<p class="first admonition-title">Solution</p>
<div class="code python last highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="sa">b</span><span class="s2">&quot;Hello World!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">greet_user</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;USER&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;Welcome </span><span class="si">{}</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()]</span> <span class="c1"># response must contain bytes</span>

<span class="n">URLS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;/&quot;</span><span class="p">:</span> <span class="n">hello_world</span><span class="p">,</span>
    <span class="s2">&quot;/greeter&quot;</span><span class="p">:</span> <span class="n">greet_user</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">URLS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">not_found</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>While this solution is pretty primitive it is understand and extend.
Essententialy, many WSGI framework have some kind of a <code class="docutils literal"><span class="pre">Mapping</span></code>
class which is responsible for this mechanism.
For example, in Djanog one defines in <code class="docutils literal"><span class="pre">urls.py</span></code> a list of patters,
which are a regular expression and callable <code class="docutils literal"><span class="pre">view</span></code>. Here is an
example from the most venerable Django polls tutorial:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="k">import</span> <span class="n">url</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">views</span>

<span class="n">app_name</span> <span class="o">=</span> <span class="s1">&#39;polls&#39;</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">IndexView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;pk&gt;\d+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;detail&#39;</span><span class="p">),</span>
    <span class="o">...</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">url</span></code> items are then matched by <a class="reference external" href="https://github.com/django/django/blob/f0ffa3f4ea277f9814285085fde20baff60fc386/django/urls/resolvers.py#L29">django.urls.resolvers.ResolverMatch</a>
A similar approach is also taken by the more modern <code class="docutils literal"><span class="pre">aiohttp</span></code> (an
honorable reference, even though it’s not a WSGI framework):</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="k">import</span> <span class="n">web</span>

<span class="o">...</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
</pre></div>
</div>
<p>Pyramid does this too:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">Configurator</span><span class="p">()</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
     <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;/hello/</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
     <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
     <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
</div>
<p>Here <code class="docutils literal"><span class="pre">add_route</span></code> creates an association between a <code class="docutils literal"><span class="pre">route_name</span></code> and
a pattern. <code class="docutils literal"><span class="pre">add_view</span></code> connects the callable <code class="docutils literal"><span class="pre">hello_world</span></code> with the route
just created.</p>
<p><code class="docutils literal"><span class="pre">Flask</span></code> and <code class="docutils literal"><span class="pre">Bottle</span></code> have an implicit way of adding <code class="docutils literal"><span class="pre">route</span></code> items to
the <code class="docutils literal"><span class="pre">Mapping</span></code>:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World!&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">app.route</span></code> adds the wrapped callable to the internal mapping inside the
<code class="docutils literal"><span class="pre">Flask</span></code> instance. In a later part of this course, we will examine later
how this decorator works.</p>
</div>
</div>
<div class="section" id="working-with-url-parameters">
<h2>Working with URL parameters<a class="headerlink" href="#working-with-url-parameters" title="Permalink to this headline">¶</a></h2>
<p>So far, we have a simple routing middleware. But it can’t work with
parameters, as seen in the Django and Pyramid examples above.
A middleware can modify the response or the environment. Modifying the latter,
we can pass new objects via the environment dictionary to the callable.</p>
<div class="section" id="exercise-5">
<h3>Exercise 5<a class="headerlink" href="#exercise-5" title="Permalink to this headline">¶</a></h3>
<p>Modify the main app matching mechanism to use regular expression groups,
to match certain URL parts as groups. These groups are the URL args,
the application can make use of. For example, calling <code class="docutils literal"><span class="pre">/hello/</span></code> should return
<code class="docutils literal"><span class="pre">hello</span> <span class="pre">wolrd!</span></code>. Calling <code class="docutils literal"><span class="pre">/hello/frank</span></code> should return <code class="docutils literal"><span class="pre">/hello/frank!</span></code>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Like the example above, but it uses the name specified in the URL.&quot;&quot;&quot;</span>
    <span class="c1"># get the name from the url if it was specified there.</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;myapp.url_args&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s1">&#39;World&#39;</span>

    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/html&#39;</span><span class="p">)])</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;&#39;&#39;Hello </span><span class="si">{}</span><span class="s1">!&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()]</span>
</pre></div>
</div>
<div class="toggle admonition">
<p class="first admonition-title">Solution</p>
<div class="code python last highlight-default"><div class="highlight"><pre><span></span><span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;hello/?$&#39;</span><span class="p">,</span> <span class="n">hello</span><span class="p">),</span>
    <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;hello/(.+)/$&#39;</span><span class="p">,</span> <span class="n">hello</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">regex</span><span class="p">,</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">environ</span><span class="p">[</span><span class="s1">&#39;myapp.url_args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">callback</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">not_found</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Python web framework from scracth</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">About this course</a></li>
<li class="toctree-l1"><a class="reference internal" href="background.html">The Web and Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="hello_world.html">Hello WSGI</a></li>
<li class="toctree-l1"><a class="reference internal" href="middlewares.html">Middlewares</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Routing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#using-path-info">Using <code class="docutils literal"><span class="pre">PATH_INFO</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-url-parameters">Working with URL parameters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="raw_wsgi.html">From Raw WSGI to a framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_model.html">Exploiting Python’s data model</a></li>
<li class="toctree-l1"><a class="reference internal" href="metaclasses.html">Metaclasses</a></li>
<li class="toctree-l1"><a class="reference internal" href="functional.html">Functional Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="summary.html">Summary</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="middlewares.html" title="previous chapter">Middlewares</a></li>
      <li>Next: <a href="raw_wsgi.html" title="next chapter">From Raw WSGI to a framework</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .admonition-title").show();
        $(".toggle .admonition-title").click(function() {
            $(this).parent().children().not(".admonition-title").toggle(400);
            $(this).parent().children(".admonition-title").toggleClass("open");
        })
    });
</script>

  </body>
</html>